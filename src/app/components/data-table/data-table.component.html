<div class="data-table-container">
  <!-- Header -->
  <div class="table-header">
    <div class="header-title">
      <ng-content select="[slot=title]"></ng-content>
    </div>
    <div class="header-actions">
      <ng-content select="[slot=actions]"></ng-content>

      <button
        *ngIf="enableViewToggle"
        class="action-btn grid-btn"
        [class.active]="viewMode === 'grid'"
        (click)="setViewMode('grid')">
        <i class="material-icons">grid_view</i>
        <span class="btn-text">شبكة</span>
      </button>
      <button
        *ngIf="enableViewToggle"
        class="action-btn table-btn"
        [class.active]="viewMode === 'table'"
        (click)="setViewMode('table')">
        <i class="material-icons">table_rows</i>
        <span class="btn-text">جدول</span>
      </button>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="filters-section" *ngIf="showSearch || showFilters">
    <div class="search-container" *ngIf="showSearch">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearch()"
          [placeholder]="searchPlaceholder"
          class="search-input"
          title="بحث"
          placeholder="بحث"
        />
        <button class="search-btn" (click)="onSearch()">
          <i class="material-icons">search</i>
          <span class="btn-text">بحث</span>
        </button>
      </div>
    </div>

    <div class="filters-row" *ngIf="showFilters">
      <ng-content select="[slot=filters]"></ng-content>
    </div>
  </div>

  <!-- Table View -->
  <div class="table-container" *ngIf="viewMode === 'table'">
    <table class="data-table">
      <thead>
        <tr>
          <th *ngIf="selectable" class="checkbox-col">
            <input
              type="checkbox"
              [checked]="selectAll"
              (change)="toggleSelectAll($event)"
              [title]="'تحديد/إلغاء تحديد الكل'"
              aria-label="تحديد/إلغاء تحديد الكل"
            />
          </th>
          <th
            *ngFor="let column of columns; let i = index"
            [class]="'col-' + column.key"
            [class.sortable]="column.sortable"
            [style.width]="column.width"
            [style.text-align]="column.align || 'right'"
            (click)="onSort(column, i)"
          >
            {{ column.title }}
            <i
              *ngIf="column.sortable"
              class="material-icons sort-icon"
            >{{ getSortIcon(column) }}</i>
          </th>
          <th *ngIf="actions.length > 0" class="actions-col">إجراءات</th>
        </tr>
      </thead>
      <tbody>
        <!-- Loading State -->
        <tr *ngIf="loading">
          <td [attr.colspan]="columns.length + (selectable ? 1 : 0) + (actions.length > 0 ? 1 : 0)" class="loading-cell">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <span>جاري التحميل...</span>
            </div>
          </td>
        </tr>

        <!-- Empty State -->
        <tr *ngIf="!loading && data.length === 0">
          <td [attr.colspan]="columns.length + (selectable ? 1 : 0) + (actions.length > 0 ? 1 : 0)" class="empty-cell">
            <div class="empty-content">
              <i class="material-icons">inbox</i>
              <span>{{ emptyMessage }}</span>
            </div>
          </td>
        </tr>

        <!-- Data Rows -->
        <tr
          *ngFor="let item of data; let i = index"
          [class.selected]="isSelected(item)"
          (click)="onRowClick(item)"
        >
          <td *ngIf="selectable" class="checkbox-col">
            <input
              type="checkbox"
              [checked]="isSelected(item)"
              (change)="toggleItemSelection(item, $event)"
              (click)="$event.stopPropagation()"
              placeholder="تحديد العنصر"
              title="تحديد العنصر"
            />
          </td>

          <td
            *ngFor="let column of columns"
            [class]="'col-' + column.key"
            [style.text-align]="column.align || 'right'"
          >
            <!-- Image Type -->
            <div *ngIf="column.type === 'image'" class="cell-image">
              <img
                [src]="getCellValue(item, column) || '/placeholder.svg'"
                alt="{{item.name }}|| 'صورة'"
                class="table-image"
              />
            </div>

            <!-- Badge Type -->
            <span
              *ngIf="column.type === 'badge'"
              class="status-badge"
              [class]="getStatusClass(getCellValue(item, column))"
            >
              {{ getCellValue(item, column) }}
            </span>

            <!-- Currency Type -->
            <span
              *ngIf="column.type === 'currency'"
              class="currency-value"
            >
              {{ formatCurrency(getCellValue(item, column)) }}
            </span>

            <!-- Date Type -->
            <span
              *ngIf="column.type === 'date'"
              class="date-value"
            >
              {{ formatDate(getCellValue(item, column)) }}
            </span>

            <!-- Text Type (Default) -->
            <span
              *ngIf="!column.type || column.type === 'text'"
              class="text-value"
              [title]="getCellValue(item, column)"
            >
              {{ getCellValue(item, column) }}
            </span>
          </td>

          <td *ngIf="actions.length > 0" class="actions-col">
            <div class="actions-menu" [class.open]="activeMenu === i">
              <button
                class="menu-trigger"
                (click)="toggleMenu(i, $event)"
              >
                <i class="material-icons">more_vert</i>
              </button>
              <div class="menu-dropdown" *ngIf="activeMenu === i">
                <button
                  *ngFor="let action of actions"
                  class="menu-item"
                  [class.danger]="action.type === 'danger'"
                  (click)="onActionClick(action.action, item)"
                >
                  <i class="material-icons">{{ action.icon }}</i>
                  {{ action.label }}
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Grid View -->
  <div class="grid-container" *ngIf="viewMode === 'grid'">
    <!-- Loading State -->
    <div class="loading-grid" *ngIf="loading">
      <div class="loading-spinner"></div>
      <span>جاري التحميل...</span>
    </div>

    <!-- Empty State -->
    <div class="empty-grid" *ngIf="!loading && data.length === 0">
      <i class="material-icons">inbox</i>
      <span>{{ emptyMessage }}</span>
    </div>

    <!-- Grid Cards -->
    <div
      class="grid-card"
      *ngFor="let item of data; let i = index"
      [class.selected]="isSelected(item)"
      (click)="onRowClick(item)"
    >
      <div class="card-header">
        <div class="card-checkbox" *ngIf="selectable">
          <input
            type="checkbox"
            [checked]="isSelected(item)"
            (change)="toggleItemSelection(item, $event)"
            (click)="$event.stopPropagation()"
            placeholder="تحديد العنصر"
            title="تحديد العنصر"
          />
        </div>
        <div class="card-actions" *ngIf="actions.length > 0">
          <div class="actions-menu" [class.open]="activeMenu === i">
            <button
              class="menu-trigger"
              (click)="toggleMenu(i, $event)"
            >
              <i class="material-icons">more_vert</i>
            </button>
            <div class="menu-dropdown" *ngIf="activeMenu === i">
              <button
                *ngFor="let action of actions"
                class="menu-item"
                [class.danger]="action.type === 'danger'"
                (click)="onActionClick(action.action, item)"
              >
                <i class="material-icons">{{ action.icon }}</i>
                {{ action.label }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="card-content">
        <!-- Default card content -->
        <div class="default-card-content">
          <div class="card-image" *ngIf="getImageColumn()">
            <img
              [src]="getCellValue(item, getImageColumn()!) || '/placeholder.svg'"
              alt="item.name || 'صورة'"
              class="card-img"
            />
          </div>

          <div class="card-info">
            <h3 class="card-title">{{ item.name || item.title || 'عنصر' }}</h3>
            <p class="card-description">{{ item.description || '' }}</p>

            <div class="card-details">
              <div
                *ngFor="let column of getDisplayColumns()"
                class="detail-item"
              >
                <span class="detail-label">{{ column.title }}:</span>
                <span class="detail-value">
                  <span
                    *ngIf="column.type === 'badge'"
                    class="status-badge"
                    [class]="getStatusClass(getCellValue(item, column))"
                  >
                    {{ getCellValue(item, column) }}

                  </span>
                  <span
                    *ngIf="column.type === 'currency'"
                    class="currency-value"
                  >
                    {{ formatCurrency(getCellValue(item, column)) }}
                  </span>
                  <span *ngIf="!column.type || column.type === 'text'">
                    {{ getCellValue(item, column) }}
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Always Visible Pagination -->
  <div class="pagination-container">
    <div class="pagination-info">
      <span>عرض {{ startItem }} إلى {{ endItem }} من {{ totalItems }} عنصر</span>
    </div>

    <div class="pagination-controls">
      <button
        class="pagination-btn"
        [disabled]="currentPage === 1"
        (click)="goToFirstPage()"
        title="الصفحة الأولى"
      >
        <i class="material-icons">first_page</i>
      </button>

      <button
        class="pagination-btn"
        [disabled]="currentPage === 1"
        (click)="goToPreviousPage()"
        title="الصفحة السابقة"
      >
        <i class="material-icons">chevron_right</i>
      </button>

      <div class="pagination-pages">
        <button
          *ngFor="let page of pageNumbers"
          class="page-btn"
          [class.active]="page === currentPage"
          [class.ellipsis]="page === -1"
          [disabled]="page === -1"
          (click)="page !== -1 && onPageChange(page)"
        >
          {{ page === -1 ? '...' : page }}
        </button>
      </div>

      <button
        class="pagination-btn"
        [disabled]="currentPage === totalPages"
        (click)="goToNextPage()"
        title="الصفحة التالية"
      >
        <i class="material-icons">chevron_left</i>
      </button>

      <button
        class="pagination-btn"
        [disabled]="currentPage === totalPages"
        (click)="goToLastPage()"
        title="الصفحة الأخيرة"
      >
        <i class="material-icons">last_page</i>
      </button>
    </div>

    <div class="page-size-selector">
      <span>عناصر لكل صفحة:</span>
      <select
        [ngModel]="pageSize"
        (ngModelChange)="onPageSizeChange($event)"
        aria-label="تحديد عدد العناصر لكل صفحة"
        title="تحديد عدد العناصر لكل صفحة"
      >
        <option *ngFor="let size of pageSizeOptions" [ngValue]="size">{{ size }}</option>
      </select>
    </div>
  </div>
</div>
