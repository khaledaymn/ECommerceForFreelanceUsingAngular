<div *ngIf="isOpen" class="modal-overlay">
  <div class="modal-container" (click)="$event.stopPropagation()" dir="rtl">
    <form (ngSubmit)="onSubmit()" #categoryForm="ngForm" class="modal-form">
      <!-- Header -->
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="material-icons">{{ category ? 'edit' : 'add' }}</i>
          </div>
          <div class="header-text">
            <h2 class="modal-title">{{ category ? 'تعديل الفئة' : 'إضافة فئة جديدة' }}</h2>
            <p class="modal-subtitle">{{ category ? 'قم بتعديل بيانات الفئة' : 'أضف فئة جديدة لتنظيم المنتجات' }}</p>
          </div>
        </div>
        <button type="button" class="close-btn" (click)="onClose()">
          <i class="material-icons">close</i>
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- Name Field -->
        <div class="form-group">
          <label for="name" class="form-label required">
            <i class="material-icons">label</i>
            اسم الفئة
          </label>
          <input
            type="text"
            id="name"
            name="name"
            [(ngModel)]="formData.name"
            required
            class="form-input"
            placeholder="أدخل اسم الفئة"
            dir="rtl"
            #nameField="ngModel"
            (focus)="onInputFocus($event)"
            (blur)="onInputBlur($event)"
          />
          <div *ngIf="nameField.invalid && nameField.touched" class="error-message">
            <i class="material-icons">error</i>
            اسم الفئة مطلوب
          </div>
        </div>

        <!-- Description Field -->
        <div class="form-group">
          <label for="description" class="form-label">
            <i class="material-icons">description</i>
            الوصف
          </label>
          <textarea
            id="description"
            name="description"
            [(ngModel)]="formData.description"
            rows="3"
            class="form-textarea"
            placeholder="أدخل وصف الفئة (اختياري)"
            dir="rtl"
            (focus)="onInputFocus($event)"
            (blur)="onInputBlur($event)"
          ></textarea>
        </div>

        <!-- Image Upload -->
        <div class="form-group">
          <label class="form-label">
            <i class="material-icons">image</i>
            صورة الفئة
          </label>
          
          <div class="upload-container">
            <!-- Image Preview Area -->
            <div *ngIf="hasImageToDisplay(); else uploadArea" 
                 class="image-preview"
                 [class.editing-preview]="isExistingImage()"
                 [class.new-image-preview]="!isExistingImage()">
              <img 
                [src]="getImageSource()" 
                alt="معاينة الصورة" 
                class="preview-image"
                (error)="onImageError($event)"
                (load)="imageError = null"
              />
              
              <!-- Existing Image Badge -->
              <div *ngIf="isExistingImage()" class="existing-image-badge">
                <i class="material-icons">check_circle</i>
                <span>صورة موجودة</span>
              </div>
              
              <!-- New Image Badge -->
              <div *ngIf="!isExistingImage() && formData.image" class="new-image-badge">
                <i class="material-icons">add_circle</i>
                <span>صورة جديدة</span>
              </div>
              
              <!-- Image Overlay Controls -->
              <div class="image-overlay">
                <button type="button" class="overlay-btn change-btn" (click)="triggerFileInput()">
                  <i class="material-icons">edit</i>
                  {{ isExistingImage() ? 'تغيير' : 'تعديل' }}
                </button>
                <button type="button" class="overlay-btn remove-btn" (click)="removeImage()">
                  <i class="material-icons">delete</i>
                  حذف
                </button>
              </div>
            </div>
            
            <!-- Upload Area (shown when no image) -->
            <ng-template #uploadArea>
              <div 
                class="upload-area" 
                [class.drag-over]="dragOver"
                (click)="triggerFileInput()"
              >
                <div class="upload-content">
                  <div class="upload-icon">
                    <i class="material-icons">cloud_upload</i>
                  </div>
                  <h3 class="upload-title">اختر صورة للفئة</h3>
                  <p class="upload-subtitle">اسحب الصورة هنا أو اضغط للاختيار</p>
                  <div class="upload-specs">
                    <span class="spec-item">PNG, JPG, JPEG, WebP, SVG</span>
                    <span class="spec-divider">•</span>
                    <span class="spec-item">حد أقصى 3MB</span>
                  </div>
                </div>
              </div>
            </ng-template>
            
            <!-- Hidden File Input -->
            <input
              #fileInput
              type="file"
              class="file-input"
              accept="image/*"
              (change)="onImageChange($event)"
              title="اختر صورة للفئة"
              placeholder="اختر صورة للفئة"
            />
          </div>
          
          <!-- Error Message -->
          <div *ngIf="imageError" class="error-message">
            <i class="material-icons">error</i>
            {{ imageError }}
          </div>
         
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="onClose()">
          <i class="material-icons">close</i>
          إلغاء
        </button>
        <button
          type="submit"
          [disabled]="categoryForm.invalid || isSubmitting"
          class="btn btn-primary"
          [class.loading]="isSubmitting"
        >
          <i *ngIf="isSubmitting" class="material-icons spinning">refresh</i>
          <i *ngIf="!isSubmitting" class="material-icons">{{ category ? 'save' : 'add' }}</i>
          <span class="btn-text">{{ category ? 'حفظ التغييرات' : 'إضافة الفئة' }}</span>
        </button>
      </div>
    </form>
  </div>
</div>
