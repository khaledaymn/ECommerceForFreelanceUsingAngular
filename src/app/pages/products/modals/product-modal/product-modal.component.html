<div class="modal-overlay" *ngIf="isOpen">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="material-icons">{{
            isEditingMode ? "edit" : "add_shopping_cart"
          }}</i>
        </div>
        <div class="header-text">
          <h2 class="modal-title">
            {{ isEditingMode ? "تعديل المنتج" : "إضافة منتج جديد" }}
          </h2>
          <p class="modal-subtitle">
            {{
              isEditingMode
                ? "قم بتعديل بيانات المنتج"
                : "قم بإدخال بيانات المنتج الجديد"
            }}
          </p>
        </div>
      </div>
      <button class="close-button" (click)="onClose()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <form #productForm="ngForm" (ngSubmit)="onSubmit()">
        <div class="form-content">
          <!-- Images Section -->
          <div class="images-section">
            <!-- Main Image Upload -->
            <div class="main-image-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">image</i>
                  <span>الصورة الرئيسية</span>
                  <span class="required-indicator">*</span>
                </div>
              </div>
              <div class="main-image-upload">
                <div class="image-preview" *ngIf="mainImagePreview">
                  <img
                    [src]="mainImagePreview"
                    alt="formData.name"
                    class="preview-image"
                  />
                  <div class="image-actions">
                    <button
                      type="button"
                      class="remove-image-button"
                      (click)="removeMainImage()"
                    >
                      <i class="material-icons">delete</i>
                    </button>
                    <button
                      type="button"
                      class="change-image-button"
                      (click)="triggerMainImageInput()"
                    >
                      <i class="material-icons">edit</i>
                      <span>تغيير الصورة</span>
                    </button>
                  </div>
                  <div class="image-badge" *ngIf="isExistingMainImage()">
                    موجودة
                  </div>
                </div>
                <div
                  class="upload-area"
                  [class.has-image]="mainImagePreview"
                  [class.drag-over]="dragOver"
                  (click)="triggerMainImageInput()"
                  (dragover)="onDragOver($event)"
                  (dragleave)="onDragLeave($event)"
                  (drop)="onMainImageDrop($event)"
                  *ngIf="!mainImagePreview"
                >
                  <div class="upload-content">
                    <i class="material-icons">cloud_upload</i>
                    <span class="upload-text">اختر صورة أو اسحبها هنا</span>
                    <span class="upload-hint">PNG, JPG, WebP حتى 3MB</span>
                  </div>
                </div>
                <input
                  #mainImageInput
                  type="file"
                  accept="image/png,image/jpeg,image/webp,image/svg+xml"
                  (change)="onMainImageChange($event)"
                  class="file-input"
                  name="mainImage"
                  title="اختر صورة رئيسية"
                  placeholder="اختر صورة رئيسية"
                />
                <div class="error-message" *ngIf="mainImageError">
                  <i class="material-icons">error</i>
                  {{ mainImageError }}
                </div>
              </div>
            </div>

            <!-- Additional Images Upload -->
            <div class="additional-images-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">photo_library</i>
                  <span>صور إضافية</span>
                  <span class="images-count" *ngIf="getImages().length > 0"
                    >({{ getImages().length }})</span
                  >
                </div>
                <button
                  type="button"
                  class="add-images-button"
                  (click)="triggerAdditionalMediaInput()"
                >
                  <i class="material-icons">add_photo_alternate</i>
                  <span>إضافة صور</span>
                </button>
              </div>
              <div
                class="additional-images-grid"
                *ngIf="getImages().length > 0"
              >
                <div
                  *ngFor="let preview of getImages(); let i = index"
                  class="image-item"
                >
                  <div class="image-container">
                    <img
                      [src]="preview.url"
                      alt="'صورة إضافية ' + (i + 1)"
                      class="additional-image"
                    />
                    <div class="image-overlay">
                      <button
                        type="button"
                        class="remove-button"
                        (click)="
                          removeAdditionalMedia(preview.originalIndex ?? i)
                        "
                      >
                        <i class="material-icons">delete</i>
                      </button>
                    </div>
                    <div
                      class="image-badge"
                      [class.existing]="preview.isExisting"
                    >
                      {{ preview.isExisting ? "موجودة" : "جديدة" }}
                    </div>
                  </div>
                </div>
              </div>
              <div class="upload-placeholder" *ngIf="getImages().length === 0">
                <i class="material-icons">photo_library</i>
                <span>لم يتم إضافة صور إضافية</span>
              </div>
            </div>

            <!-- Videos Upload -->
            <div class="videos-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">video_library</i>
                  <span>الفيديوهات</span>
                  <span class="images-count" *ngIf="getVideos().length > 0"
                    >({{ getVideos().length }})</span
                  >
                </div>
                <button
                  type="button"
                  class="add-images-button"
                  (click)="triggerAdditionalMediaInput()"
                >
                  <i class="material-icons">add_circle</i>
                  <span>إضافة فيديو</span>
                </button>
              </div>
              <div class="videos-grid" *ngIf="getVideos().length > 0">
                <div
                  *ngFor="let preview of getVideos(); let i = index"
                  class="video-item"
                >
                  <div class="video-container">
                    <video
                      [src]="preview.url"
                      controls
                      class="video-player"
                    ></video>
                    <div class="image-overlay">
                      <button
                        type="button"
                        class="remove-button"
                        (click)="
                          removeAdditionalMedia(preview.originalIndex ?? i)
                        "
                      >
                        <i class="material-icons">delete</i>
                      </button>
                    </div>
                    <div
                      class="image-badge"
                      [class.existing]="preview.isExisting"
                    >
                      {{ preview.isExisting ? "موجود" : "جديد" }}
                    </div>
                    <div class="media-type-badge">
                      <i class="material-icons">play_circle</i>
                    </div>
                  </div>
                </div>
              </div>
              <div class="upload-placeholder" *ngIf="getVideos().length === 0">
                <i class="material-icons">video_library</i>
                <span>لم يتم إضافة فيديوهات</span>
              </div>
            </div>

            <!-- PDFs Upload -->
            <div class="pdfs-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">picture_as_pdf</i>
                  <span>المستندات</span>
                  <span class="images-count" *ngIf="getPdfs().length > 0"
                    >({{ getPdfs().length }})</span
                  >
                </div>
                <button
                  type="button"
                  class="add-images-button"
                  (click)="triggerAdditionalMediaInput()"
                >
                  <i class="material-icons">add_circle</i>
                  <span>إضافة مستند</span>
                </button>
              </div>
              <div class="pdfs-grid" *ngIf="getPdfs().length > 0">
                <div
                  *ngFor="let preview of getPdfs(); let i = index"
                  class="pdf-item"
                >
                  <div class="pdf-container">
                    <a [href]="preview.url" target="_blank" class="pdf-link">
                      <i class="material-icons">picture_as_pdf</i>
                      <span>مستند {{ i + 1 }}</span>
                    </a>
                    <div class="image-overlay">
                      <button
                        type="button"
                        class="remove-button"
                        (click)="
                          removeAdditionalMedia(preview.originalIndex ?? i)
                        "
                      >
                        <i class="material-icons">delete</i>
                      </button>
                    </div>
                    <div
                      class="image-badge"
                      [class.existing]="preview.isExisting"
                    >
                      {{ preview.isExisting ? "موجود" : "جديد" }}
                    </div>
                  </div>
                </div>
              </div>
              <div class="upload-placeholder" *ngIf="getPdfs().length === 0">
                <i class="material-icons">picture_as_pdf</i>
                <span>لم يتم إضافة مستندات</span>
              </div>
            </div>

            <input
              #additionalMediaInput
              type="file"
              accept="image/png,image/jpeg,image/webp,image/svg+xml,video/mp4,video/webm,video/mov,video/mkv,application/pdf"
              multiple
              (change)="onAdditionalMediaChange($event)"
              class="file-input"
              name="additionalMedia"
              placeholder="اختر ملفات الوسائط"
              title="إضافة صور أو فيديوهات أو مستندات"
            />
            <div class="error-message" *ngIf="additionalMediaError">
              <i class="material-icons">error</i>
              {{ additionalMediaError }}
            </div>
          </div>

          <!-- Form Fields Section -->
          <div class="form-section">
            <!-- Basic Information -->
            <div class="form-group-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">info</i>
                  <span>المعلومات الأساسية</span>
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">
                    <span>اسم المنتج</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <input
                    type="text"
                    [(ngModel)]="formData.name"
                    name="name"
                    required
                    class="form-input"
                    placeholder="أدخل اسم المنتج"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span>العلامة التجارية</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <input
                    type="text"
                    [(ngModel)]="formData.brand"
                    name="brand"
                    required
                    class="form-input"
                    placeholder="أدخل العلامة التجارية"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span>الموديل</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <input
                    type="text"
                    [(ngModel)]="formData.model"
                    name="model"
                    required
                    class="form-input"
                    placeholder="أدخل الموديل"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span>الفئة</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <select
                    [(ngModel)]="formData.categoryId"
                    name="categoryId"
                    required
                    class="form-select"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                    aria-label="الفئة"
                  >
                    <option value="">اختر الفئة</option>
                    <option
                      *ngFor="let category of categories"
                      [value]="category.id"
                    >
                      {{ category.name }}
                    </option>
                  </select>
                </div>
                <!-- بدل الـ select القديم للحالة -->
                <div class="form-group">
                  <label class="form-label">
                    <span>الحالة</span>
                    <span class="required-indicator">*</span>
                  </label>

                  <div class="multi-select-wrapper">
                    <div
                      class="multi-select-dropdown"
                      [class.active]="statusDropdownOpen"
                      (click)="toggleStatusDropdown()"
                    >
                      <div class="selected-display">
                        <div class="selected-items">
                          <ng-container
                            *ngIf="getStatusArray().length > 0; else noStatus"
                          >
                            <span
                              *ngFor="let item of getStatusArray()"
                              class="selected-badge"
                              [class.sale]="item === 'بيع'"
                              [class.purchase]="item === 'شراء'"
                              [class.lease]="item === 'إيجار'"
                            >
                              <i [class]="getStatusIcon(item)"></i>
                              {{ item }}
                              <button
                                type="button"
                                class="remove-btn"
                                (click)="
                                  toggleStatusItem(item);
                                  $event.stopPropagation()
                                "
                              >
                                ×
                              </button>
                            </span>
                          </ng-container>
                          <ng-template #noStatus>
                            <span class="placeholder">اختر الحالة...</span>
                          </ng-template>
                        </div>
                        <i
                          class="fa fa-chevron-down arrow"
                          [class.rotated]="statusDropdownOpen"
                        ></i>
                      </div>
                    </div>

                    <div
                      class="dropdown-options"
                      [class.show]="statusDropdownOpen"
                    >
                      <div
                        class="option"
                        [class.selected]="isStatusSelected('شراء')"
                        (click)="toggleStatusItem('شراء')"
                      >
                        <i class="fa fa-shopping-cart icon"></i>
                        <span>شراء</span>
                        <i
                          class="fa fa-check check"
                          *ngIf="isStatusSelected('شراء')"
                        ></i>
                      </div>

                      <div
                        class="option"
                        [class.selected]="isStatusSelected('إيجار')"
                        (click)="toggleStatusItem('إيجار')"
                      >
                        <i class="fa fa-key icon"></i>
                        <span>إيجار</span>
                        <i
                          class="fa fa-check check"
                          *ngIf="isStatusSelected('إيجار')"
                        ></i>
                      </div>

                      <div
                        class="option sale"
                        [class.selected]="isStatusSelected('بيع')"
                        (click)="toggleStatusItem('بيع')"
                      >
                        <i class="fa fa-sign-hanging icon"></i>
                        <span>بيع</span>
                        <i
                          class="fa fa-check check"
                          *ngIf="isStatusSelected('بيع')"
                        ></i>
                      </div>
                    </div>
                  </div>

                  <!-- حقل مخفي للـ ngModel عشان الـ validation يشتغل -->
                  <input
                    type="hidden"
                    [(ngModel)]="formData.status"
                    name="status"
                    required
                    #statusInput="ngModel"
                  />

                  <div
                    class="error-message"
                    *ngIf="statusInput.invalid && statusInput.touched"
                  >
                    <i class="material-icons">error</i>
                    يجب اختيار حالة واحدة على الأقل
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span>الكميه</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <input
                    type="number"
                    [(ngModel)]="formData.quantity"
                    name="quantity"
                    required
                    class="form-input"
                    placeholder="أدخل الكميه"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                  />
                </div>
              </div>
              <div class="form-group full-width">
                <label class="form-label">
                  <span>الوصف</span>
                </label>
                <textarea
                  [(ngModel)]="formData.description"
                  name="description"
                  class="form-textarea"
                  placeholder="أدخل وصف المنتج..."
                  rows="4"
                  (focus)="onInputFocus($event)"
                  (blur)="onInputBlur($event)"
                ></textarea>
              </div>
            </div>

            <!-- Additional Attributes -->
            <div class="form-group-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">tune</i>
                  <span>خصائص إضافية</span>
                </div>
              </div>
              <div
                class="attributes-list"
                *ngIf="getAttributesArray().length > 0"
              >
                <div
                  *ngFor="
                    let attr of getAttributesArray();
                    trackBy: trackByAttributeKey
                  "
                  class="attribute-item"
                >
                  <div class="attribute-content">
                    <div class="attribute-key">{{ attr.key }}</div>
                    <div class="attribute-value">{{ attr.value }}</div>
                  </div>
                  <button
                    type="button"
                    class="remove-attribute-button"
                    (click)="removeAttribute(attr.key)"
                  >
                    <i class="material-icons">close</i>
                  </button>
                </div>
              </div>
              <div class="add-attribute-form">
                <div class="attribute-inputs">
                  <input
                    type="text"
                    [(ngModel)]="newAttribute.key"
                    name="newAttributeKey"
                    class="form-input"
                    placeholder="اسم الخاصية"
                  />
                  <input
                    type="text"
                    [(ngModel)]="newAttribute.value"
                    name="newAttributeValue"
                    class="form-input"
                    placeholder="قيمة الخاصية"
                  />
                  <button
                    type="button"
                    class="add-attribute-button"
                    (click)="addAttribute()"
                    [disabled]="
                      !newAttribute.key.trim() || !newAttribute.value.trim()
                    "
                  >
                    <i class="material-icons">add</i>
                    <span>إضافة</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="footer-actions">
        <button
          type="button"
          class="action-button secondary-button"
          (click)="onClose()"
        >
          <i class="material-icons">close</i>
          <span>إلغاء</span>
        </button>
        <button
          type="submit"
          class="action-button primary-button"
          (click)="onSubmit()"
          [disabled]="isSubmitting || productForm.invalid"
        >
          <div class="button-content">
            <div class="loading-spinner" *ngIf="isSubmitting"></div>
            <i class="material-icons" *ngIf="!isSubmitting">{{
              isEditingMode ? "save" : "add"
            }}</i>
            <span>{{
              isSubmitting
                ? "جاري الحفظ..."
                : isEditingMode
                ? "حفظ التغييرات"
                : "إضافة المنتج"
            }}</span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>
