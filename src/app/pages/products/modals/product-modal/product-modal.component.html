<div class="modal-overlay" *ngIf="isOpen" (click)="onClose()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="material-icons">{{
            isEditingMode ? "edit" : "add_shopping_cart"
          }}</i>
        </div>
        <div class="header-text">
          <h2 class="modal-title">
            {{ isEditingMode ? "تعديل المنتج" : "إضافة منتج جديد" }}
          </h2>
          <p class="modal-subtitle">
            {{
              isEditingMode
                ? "قم بتعديل بيانات المنتج"
                : "قم بإدخال بيانات المنتج الجديد"
            }}
          </p>
        </div>
      </div>
      <button class="close-button" (click)="onClose()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <form (ngSubmit)="onSubmit()" #productForm="ngForm">
        <div class="form-content">
          <!-- Images Section -->
          <div class="images-section">
            <!-- Main Image Upload -->
            <div class="main-image-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">image</i>
                  <span>الصورة الرئيسية</span>
                  <span class="required-indicator">*</span>
                </div>
              </div>

              <div class="main-image-upload">
                <div class="image-preview" *ngIf="mainImagePreview">
                  <img
                    [src]="mainImagePreview"
                    alt="formData.name"
                    class="preview-image"
                  />
                  <div class="image-actions">
                    <button
                      type="button"
                      class="remove-image-button"
                      (click)="removeMainImage()"
                    >
                      <i class="material-icons">delete</i>
                    </button>
                  </div>
                  <div class="image-badge" *ngIf="isExistingMainImage()">
                    موجودة
                  </div>
                </div>

                <div
                  class="upload-area"
                  [class.has-image]="mainImagePreview"
                  [class.drag-over]="dragOver"
                  (click)="triggerMainImageInput()"
                  (dragover)="onDragOver($event)"
                  (dragleave)="onDragLeave($event)"
                  (drop)="onMainImageDrop($event)"
                  *ngIf="!mainImagePreview"
                >
                  <div class="upload-content">
                    <i class="material-icons">cloud_upload</i>
                    <span class="upload-text">اختر صورة أو اسحبها هنا</span>
                    <span class="upload-hint">PNG, JPG, WebP حتى 3MB</span>
                  </div>
                </div>

                <input
                  #mainImageInput
                  type="file"
                  accept="image/*"
                  (change)="onMainImageChange($event)"
                  class="file-input"
                  placeholder="اختر صورة رئيسية"
                  title="اختر صورة رئيسية"
                />

                <div class="error-message" *ngIf="mainImageError">
                  <i class="material-icons">error</i>
                  {{ mainImageError }}
                </div>
              </div>
            </div>

            <!-- Additional Images Upload -->
            <div class="additional-images-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">photo_library</i>
                  <span>صور إضافية</span>
                  <span
                    class="images-count"
                    *ngIf="additionalImagePreviews.length > 0"
                  >
                    ({{ additionalImagePreviews.length }})
                  </span>
                </div>
                <button
                  type="button"
                  class="add-images-button"
                  (click)="triggerAdditionalImagesInput()"
                >
                  <i class="material-icons">add_photo_alternate</i>
                  <span>إضافة صور</span>
                </button>
              </div>

              <div
                class="additional-images-grid"
                *ngIf="additionalImagePreviews.length > 0"
              >
                <div
                  *ngFor="let preview of additionalImagePreviews; let i = index"
                  class="image-item"
                >
                  <div class="image-container">
                    <img
                      [src]="preview.url"
                      alt="'صورة إضافية ' + {{ i + 1 }}"
                      class="additional-image"
                    />
                    <div class="image-overlay">
                      <button
                        type="button"
                        class="remove-button"
                        (click)="removeAdditionalImage(i)"
                      >
                        <i class="material-icons">delete</i>
                      </button>
                    </div>
                    <div
                      class="image-badge"
                      [class.existing]="preview.isExisting"
                    >
                      {{ preview.isExisting ? "موجودة" : "جديدة" }}
                    </div>
                    <div class="media-type-badge" *ngIf="preview.isVideo">
                      <i class="material-icons">videocam</i>
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="upload-placeholder"
                *ngIf="additionalImagePreviews.length === 0"
              >
                <i class="material-icons">photo_library</i>
                <span>لم يتم إضافة صور إضافية</span>
              </div>

              <input
                #additionalImagesInput
                type="file"
                accept="image/*,video/*"
                multiple
                (change)="onAdditionalImagesChange($event)"
                class="file-input"
                placeholder="اختر صور أو فيديوهات إضافية"
                title="اختر صور أو فيديوهات إضافية"
              />

              <div class="error-message" *ngIf="additionalImagesError">
                <i class="material-icons">error</i>
                {{ additionalImagesError }}
              </div>
            </div>
          </div>

          <!-- Form Fields Section -->
          <div class="form-section">
            <!-- Basic Information -->
            <div class="form-group-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">info</i>
                  <span>المعلومات الأساسية</span>
                </div>
              </div>

              <div class="form-grid">
                <!-- Product Name -->
                <div class="form-group">
                  <label class="form-label">
                    <span>اسم المنتج</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <input
                    type="text"
                    [(ngModel)]="formData.name"
                    name="name"
                    required
                    class="form-input"
                    placeholder="أدخل اسم المنتج"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span>العلامة التجارية</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <input
                    type="text"
                    [(ngModel)]="formData.brand"
                    name="brand"
                    required
                    class="form-input"
                    placeholder="أدخل العلامة التجارية"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <span>الموديل</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <input
                    type="text"
                    [(ngModel)]="formData.model"
                    name="model"
                    required
                    class="form-input"
                    placeholder="أدخل الموديل"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                  />
                </div>
                <!-- Category -->
                <div class="form-group">
                  <label class="form-label">
                    <span>الفئة</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <select
                    [(ngModel)]="formData.categoryId"
                    name="categoryId"
                    required
                    class="form-select"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                    aria-label="الفئة"
                  >
                    <option value="">اختر الفئة</option>
                    <option
                      *ngFor="let category of categories"
                      [value]="category.id"
                    >
                      {{ category.name }}
                    </option>
                  </select>
                </div>

                <!-- Brand -->

                <!-- Status -->
                <div class="form-group">
                  <label class="form-label">
                    <span>الحالة</span>
                    <span class="required-indicator">*</span>
                  </label>
                  <select
                    [(ngModel)]="formData.status"
                    name="status"
                    required
                    class="form-select"
                    (focus)="onInputFocus($event)"
                    (blur)="onInputBlur($event)"
                    aria-label="الحالة"
                  >
                    <option value="متوفر">متوفر</option>
                    <option value="غير متوفر">غير متوفر</option>
                    <option value="قريباً">قريباً</option>
                  </select>
                </div>
              </div>

              <!-- Description -->
              <div class="form-group full-width">
                <label class="form-label">
                  <span>الوصف</span>
                </label>
                <textarea
                  [(ngModel)]="formData.description"
                  name="description"
                  class="form-textarea"
                  placeholder="أدخل وصف المنتج..."
                  rows="4"
                  (focus)="onInputFocus($event)"
                  (blur)="onInputBlur($event)"
                ></textarea>
              </div>
            </div>

            <!-- Additional Attributes -->
            <div class="form-group-section">
              <div class="section-header">
                <div class="section-title">
                  <i class="material-icons">tune</i>
                  <span>خصائص إضافية</span>
                </div>
              </div>

              <!-- Existing Attributes -->
              <div
                class="attributes-list"
                *ngIf="getAttributesArray().length > 0"
              >
                <div
                  *ngFor="
                    let attr of getAttributesArray();
                    trackBy: trackByAttributeKey
                  "
                  class="attribute-item"
                >
                  <div class="attribute-content">
                    <div class="attribute-key">{{ attr.key }}</div>
                    <div class="attribute-value">{{ attr.value }}</div>
                  </div>
                  <button
                    type="button"
                    class="remove-attribute-button"
                    (click)="removeAttribute(attr.key)"
                  >
                    <i class="material-icons">close</i>
                  </button>
                </div>
              </div>

              <!-- Add New Attribute -->
              <div class="add-attribute-form">
                <div class="attribute-inputs">
                  <input
                    type="text"
                    [(ngModel)]="newAttribute.key"
                    name="newAttributeKey"
                    class="form-input"
                    placeholder="اسم الخاصية"
                  />
                  <input
                    type="text"
                    [(ngModel)]="newAttribute.value"
                    name="newAttributeValue"
                    class="form-input"
                    placeholder="قيمة الخاصية"
                  />
                  <button
                    type="button"
                    class="add-attribute-button"
                    (click)="addAttribute()"
                    [disabled]="
                      !newAttribute.key.trim() || !newAttribute.value.trim()
                    "
                  >
                    <i class="material-icons">add</i>
                    <span>إضافة</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="footer-actions">
        <button
          type="button"
          class="action-button secondary-button"
          (click)="onClose()"
        >
          <i class="material-icons">close</i>
          <span>إلغاء</span>
        </button>
        <button
          type="submit"
          class="action-button primary-button"
          (click)="onSubmit()"
          [disabled]="isSubmitting"
        >
          <div class="button-content">
            <div class="loading-spinner" *ngIf="isSubmitting"></div>
            <i class="material-icons" *ngIf="!isSubmitting">{{
              isEditingMode ? "save" : "add"
            }}</i>
            <span>{{
              isSubmitting
                ? "جاري الحفظ..."
                : isEditingMode
                ? "حفظ التغييرات"
                : "إضافة المنتج"
            }}</span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>
