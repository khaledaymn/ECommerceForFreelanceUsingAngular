<app-data-table
  [columns]="columns"
  [data]="filteredProducts"
  [loading]="loading"
  [actions]="actions"
  [selectable]="false"
  [viewMode]="viewMode"
  [enableViewToggle]="true"
  searchPlaceholder="البحث في المنتجات..."
  emptyMessage="لا توجد منتجات متاحة"
  [currentPage]="currentPage"
  [totalPages]="totalPages"
  [totalItems]="totalItems"
  [pageSize]="pageSize"
  [showFilters]="true"
  (searchChange)="onSearch($event)"
  (sortChange)="onSort($event)"
  (rowClick)="onRowClick($event)"
  (actionClick)="onActionClick($event)"
  (viewModeChange)="onViewModeChange($event)"
  (pageChange)="onPageChange($event)"
  (pageSizeChange)="onPageSizeChange($event)"
>
  <div slot="title" class="header-title">
    <h1>إدارة المنتجات</h1>
    <p class="header-subtitle">إدارة وتنظيم جميع المنتجات</p>
  </div>

  <div slot="actions">
    <button class="add-btn product-add-btn" (click)="openAddModal()">
      <div class="btn-icon">
        <i class="material-icons">add_shopping_cart</i>
      </div>
      <span class="btn-text">إضافة منتج</span>
      <div class="btn-shine"></div>
    </button>
  </div>

  <div slot="filters">
    <!-- Filters Toggle Button -->
    <button
      class="filters-toggle-btn"
      [class.active]="showFilters"
      (click)="toggleFiltersPanel()"
    >
      <div class="btn-icon">
        <i class="material-icons">tune</i>
      </div>
      <span class="btn-text">الفلاتر</span>
      <div class="filter-badge" *ngIf="getActiveFiltersCount() > 0">
        {{ getActiveFiltersCount() }}
      </div>
      <div class="btn-shine"></div>
    </button>
    <!-- Filters Panel -->
    <div class="filters-panel" [class.visible]="showFilters">
      <div class="filters-overlay" (click)="closeFiltersPanel()"></div>
      <div class="filters-container">
        <!-- Panel Header -->
        <div class="filters-header">
          <div class="header-content">
            <div class="header-icon">
              <i class="material-icons">tune</i>
            </div>
            <div class="header-text">
              <h3>فلترة المنتجات</h3>
              <p>اختر الفلاتر المناسبة لتصفية المنتجات</p>
            </div>
          </div>
          <div class="header-actions">
            <button
              class="clear-all-btn"
              (click)="clearAllFilters()"
              *ngIf="hasActiveFilters()"
            >
              <i class="material-icons">clear_all</i>
              مسح الكل
            </button>
            <button class="close-panel-btn" (click)="closeFiltersPanel()">
              <i class="material-icons">close</i>
            </button>
          </div>
        </div>

        <!-- Filters Content -->
        <div class="filters-content custom-scrollbar">
          <!-- Active Filters Summary -->
          <div class="active-filters-summary" *ngIf="hasActiveFilters()">
            <div class="summary-header">
              <i class="material-icons">filter_list</i>
              <span>الفلاتر النشطة ({{ getActiveFiltersCount() }})</span>
            </div>
            <div class="active-filters-tags">
              <!-- Status Filter -->
              <div class="filter-tag" *ngIf="statusFilter">
                <div class="tag-icon">
                  <i class="material-icons">inventory</i>
                </div>
                <span class="tag-label">الحالة:</span>
                <span class="tag-value">{{ statusFilter }}</span>
                <button class="tag-remove" (click)="onStatusFilterChange('')">
                  <i class="material-icons">close</i>
                </button>
              </div>

              <!-- Category Filter -->
              <div class="filter-tag" *ngIf="categoryFilter">
                <div class="tag-icon">
                  <i class="material-icons">category</i>
                </div>
                <span class="tag-label">الفئة:</span>
                <span class="tag-value">{{
                  getCategoryName(categoryFilter)
                }}</span>
                <button class="tag-remove" (click)="onCategoryFilterChange('')">
                  <i class="material-icons">close</i>
                </button>
              </div>

              <!-- Price Filter -->

              <!-- Attribute Filters -->
              <div
                *ngFor="let attr of getActiveAttributeFilters()"
                class="filter-tag"
              >
                <div class="tag-icon">
                  <i class="material-icons">tune</i>
                </div>
                <span class="tag-label">{{ attr.key }}:</span>
                <span class="tag-value">{{ attr.values.join(", ") }}</span>
                <button
                  class="tag-remove"
                  (click)="clearAttributeFilter(attr.key)"
                >
                  <i class="material-icons">close</i>
                </button>
              </div>
            </div>
          </div>

          <!-- Filters Grid -->
          <div class="filters-grid">
            <!-- Row 1: Status and Category -->
            <div class="filter-row">
              <!-- Status Filter -->
              <div class="filter-field">
                <label class="filter-label">
                  <i class="material-icons">inventory</i>
                  حالة المنتج
                </label>
                <div
                  class="searchable-select"
                  [class.open]="activeDropdown === 'status'"
                >
                  <div
                    class="select-trigger"
                    (click)="toggleDropdown('status')"
                  >
                    <span
                      class="select-value"
                      *ngIf="statusFilter; else statusPlaceholder"
                    >
                      <div
                        class="status-indicator"
                        [class]="getStatusClass(statusFilter)"
                      ></div>
                      {{ statusFilter }}
                    </span>
                    <ng-template #statusPlaceholder>
                      <span class="select-placeholder">اختر الحالة</span>
                    </ng-template>
                    <i
                      class="material-icons expand-icon"
                      [class.rotated]="activeDropdown === 'status'"
                      >expand_more</i
                    >
                  </div>

                  <div
                    class="select-dropdown"
                    *ngIf="activeDropdown === 'status'"
                  >
                    <div class="dropdown-search">
                      <input
                        type="text"
                        placeholder="البحث في الحالات..."
                        [(ngModel)]="statusSearchTerm"
                        class="search-input"
                        (click)="$event.stopPropagation()"
                      />
                      <i class="material-icons">search</i>
                    </div>

                    <div class="dropdown-options">
                      <div
                        class="dropdown-option"
                        [class.selected]="statusFilter === ''"
                        (click)="selectStatus('')"
                      >
                        <div class="option-content">
                          <i class="material-icons">all_inclusive</i>
                          <span>جميع الحالات</span>
                        </div>
                        <!-- <span class="option-count">{{ getTotalProductsCount() }}</span> -->
                      </div>

                      <div
                        *ngFor="let status of getFilteredStatuses()"
                        class="dropdown-option"
                        [class.selected]="statusFilter === status"
                        (click)="selectStatus(status)"
                      >
                        <div class="option-content">
                          <div
                            class="status-indicator"
                            [class]="getStatusClass(status)"
                          ></div>
                          <span>{{ status }}</span>
                        </div>
                        <!-- <span class="option-count">{{ getStatusCount(status) }}</span> -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Category Filter -->
              <div class="filter-field">
                <label class="filter-label">
                  <i class="material-icons">category</i>
                  فئة المنتج
                </label>
                <div
                  class="searchable-select"
                  [class.open]="activeDropdown === 'category'"
                >
                  <div
                    class="select-trigger"
                    (click)="toggleDropdown('category')"
                  >
                    <span
                      class="select-value"
                      *ngIf="categoryFilter; else categoryPlaceholder"
                    >
                      {{ getCategoryName(categoryFilter) }}
                    </span>
                    <ng-template #categoryPlaceholder>
                      <span class="select-placeholder">اختر الفئة</span>
                    </ng-template>
                    <i
                      class="material-icons expand-icon"
                      [class.rotated]="activeDropdown === 'category'"
                      >expand_more</i
                    >
                  </div>

                  <div
                    class="select-dropdown"
                    *ngIf="activeDropdown === 'category'"
                  >
                    <div class="dropdown-search">
                      <input
                        type="text"
                        placeholder="البحث في الفئات..."
                        [(ngModel)]="categorySearchTerm"
                        class="search-input"
                        (click)="$event.stopPropagation()"
                      />
                      <i class="material-icons">search</i>
                    </div>

                    <div class="dropdown-options">
                      <div
                        class="dropdown-option"
                        [class.selected]="categoryFilter === ''"
                        (click)="selectCategory('')"
                      >
                        <div class="option-content">
                          <i class="material-icons">all_inclusive</i>
                          <span>جميع الفئات</span>
                        </div>
                        <!-- <span class="option-count">{{ getTotalProductsCount() }}</span> -->
                      </div>

                      <div
                        *ngFor="let category of getFilteredCategories()"
                        class="dropdown-option"
                        [class.selected]="
                          categoryFilter === category.id.toString()
                        "
                        (click)="selectCategory(category.id.toString())"
                      >
                        <div class="option-content">
                          <div
                            class="category-image"
                            *ngIf="category.imageThumbnailURL"
                          >
                            <img
                              [src]="category.imageThumbnailURL"
                              alt="category.name"
                            />
                          </div>
                          <div
                            class="category-placeholder"
                            *ngIf="!category.imageThumbnailURL"
                          >
                            <i class="material-icons">category</i>
                          </div>
                          <span>{{ category.name }}</span>
                        </div>
                        <!-- <span class="option-count">{{ getCategoryCount(category.id) }}</span> -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Row 2: Price Range -->

            <!-- Row 3: Dynamic Attribute Filters -->
            <div
              class="filter-row attribute-filters-row"
              *ngIf="availableAttributes.length > 0"
            >
              <div
                class="filter-field attribute-field"
                *ngFor="let attribute of availableAttributes"
              >
                <label class="filter-label">
                  <i class="material-icons">tune</i>
                  {{ attribute.key }}
                </label>
                <div
                  class="searchable-select"
                  [class.open]="activeDropdown === 'attr_' + attribute.key"
                >
                  <div
                    class="select-trigger"
                    (click)="toggleDropdown('attr_' + attribute.key)"
                  >
                    <span
                      class="select-value"
                      *ngIf="
                        attributeFilters[attribute.key]?.length;
                        else attrPlaceholder
                      "
                    >
                      {{
                        attributeFilters[attribute.key].length > 1
                          ? attributeFilters[attribute.key].length +
                            " قيم محددة"
                          : attributeFilters[attribute.key][0]
                      }}
                    </span>
                    <ng-template #attrPlaceholder>
                      <span class="select-placeholder">اختر القيمة</span>
                    </ng-template>
                    <i
                      class="material-icons expand-icon"
                      [class.rotated]="
                        activeDropdown === 'attr_' + attribute.key
                      "
                      >expand_more</i
                    >
                  </div>

                  <div
                    class="select-dropdown"
                    *ngIf="activeDropdown === 'attr_' + attribute.key"
                  >
                    <div class="dropdown-search">
                      <input
                        type="text"
                        [placeholder]="'البحث في ' + attribute.key + '...'"
                        [(ngModel)]="attributeSearchTerms[attribute.key]"
                        class="search-input"
                        (click)="$event.stopPropagation()"
                        [title]="'البحث في ' + attribute.key + '...'"
                        placeholder="أدخل قيمة البحث"
                        title="حقل البحث عن قيمة السمة"
                      />
                      <i class="material-icons">search</i>
                    </div>

                    <div class="dropdown-options">
                      <div
                        *ngFor="
                          let value of getFilteredAttributeValues(attribute)
                        "
                        class="dropdown-option attribute-option"
                        [class.selected]="
                          isAttributeValueSelected(attribute.key, value.value)
                        "
                        (click)="
                          toggleAttributeValue(attribute.key, value.value)
                        "
                      >
                        <div class="option-content">
                          <div class="option-checkbox">
                            <input
                              type="checkbox"
                              [checked]="
                                isAttributeValueSelected(
                                  attribute.key,
                                  value.value
                                )
                              "
                              (click)="$event.stopPropagation()"
                              (change)="
                                toggleAttributeValue(attribute.key, value.value)
                              "
                              title="تحديد القيمة {{ value.value }} لـ {{
                                attribute.key
                              }}"
                              placeholder="تحديد القيمة {{ value.value }} لـ {{
                                attribute.key
                              }}"
                              [attr.aria-label]="
                                'تحديد القيمة ' +
                                value.value +
                                ' لـ ' +
                                attribute.key
                              "
                            />
                          </div>
                          <span>{{ value.value }}</span>
                        </div>
                        <!-- <span class="option-count">{{ value.count }}</span> -->
                      </div>
                    </div>

                    <!-- Clear attribute button -->
                    <div
                      class="dropdown-footer"
                      *ngIf="attributeFilters[attribute.key]?.length"
                    >
                      <button
                        class="clear-attribute-btn"
                        (click)="clearAttributeFilter(attribute.key)"
                      >
                        <i class="material-icons">clear</i>
                        مسح التحديد
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel Footer -->
        <div class="filters-footer">
          <div class="footer-info">
            <span class="results-count">
              <i class="material-icons">inventory_2</i>
              {{ filteredProducts.length }} منتج من أصل {{ totalItems }}
            </span>
          </div>
          <div class="footer-actions">
            <button class="apply-filters-btn" (click)="applyFilters()">
              <i class="material-icons">check</i>
              تطبيق الفلاتر
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-data-table>

<!-- Product Modal -->
<app-product-modal
  *ngIf="isModalOpen"
  [isOpen]="isModalOpen"
  [product]="editingProduct"
  [categories]="categories"
  (close)="closeModal()"
  (save)="saveProduct($event)"
/>

<!-- Product Details Modal -->
<app-product-details-modal
  *ngIf="isDetailsModalOpen"
  [isOpen]="isDetailsModalOpen"
  [product]="selectedProduct"
  [categories]="categories"
  (close)="closeDetailsModal()"
  (edit)="openEditModalFromDetails($event)"
  (delete)="openDeleteConfirmFromDetails($event)"
/>

<!-- Delete Confirmation Dialog -->
<app-confirm-dialog
  *ngIf="deleteConfirm.isOpen"
  [isOpen]="deleteConfirm.isOpen"
  title="تأكيد الحذف"
  message="هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء."
  confirmText="حذف"
  cancelText="إلغاء"
  (confirm)="confirmDelete()"
  (cancel)="closeDeleteConfirm()"
/>
